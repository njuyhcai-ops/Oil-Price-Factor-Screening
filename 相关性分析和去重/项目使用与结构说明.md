# 项目使用与结构说明

本文档说明：**本项目使用方法**、**原始文件夹与输出文件夹的结构及各项含义**、**保留/删除因子的策略**。

---

## 一、本项目使用方法

### 1.1 环境要求

- **Python**：建议 3.7 及以上。
- **依赖**：pandas, numpy, scipy, matplotlib, seaborn, scikit-learn。

安装依赖（在「相关性分析和去重」目录下）：

```bash
pip install -r requirements.txt
```

或先检查环境再安装缺失项：

```bash
python check_env.py
```

按提示执行 `pip install ...` 安装缺失包。

### 1.2 运行方式

在终端进入「相关性分析和去重」目录后执行：

```bash
python run_pipeline.py
```

将依次执行：**1 相关性分析 → 2 聚类去重 → 3 因子过滤**，结果写入 `output/`。

或者分步运行

```bash
python 1_correlation_analysis.py    # 相关性分析、每对 Pearson、图表
python 2_factor_clustering_dedup.py # 高相关去重、聚类图
python 3_factor_filter.py          # 质量过滤，得到最终保留/剔除列表
```

必须先按 1 → 2 → 3 顺序执行，后一步依赖前一步生成的 CSV。

###  配置修改

在 **`config.py`** 中可修改：

- **FACTOR_CSV**：主因子数据集路径（默认指向上一级目录的 `ULTIMATE_OIL_PRICE_DATASET.csv`）。
- **OIL_PRICE_CSV**：油价文件路径（用于计算因子与目标 IC）；设为 `None` 或不存在则跳过目标相关性与按 IC 过滤。
- **CORR_DEDUP_THRESHOLD**：高相关去重阈值，默认 0.85。
- **MIN_VALID_RATIO**：有效观测占比下限，默认 0.30。
- **MIN_TARGET_IC_ABS**：与目标 |IC| 下限，默认 0.01（仅在有油价时用于过滤）。
- **FIGURES_DIR**、**TOP_N_PAIRS_BAR**、**TOP_N_PAIRS_SCATTER**：可视化输出文件夹名与图表数量。

修改后重新运行 `run_pipeline.py` 即可得到新结果。

---

## 二、文件夹与文件结构说明

### 2.1 项目根目录（因子组）结构

```
因子组/
├── ULTIMATE_OIL_PRICE_DATASET.csv   # 主因子数据集（Date + 多列因子），本项目的输入数据
├── 原油价格预测因子数据集使用说明.docx
├── 数据集/                           # 原始数据来源（油价、钻机数、柴油价等）
│   ├── DCOILWTICO.csv               # 油价，用于计算因子-目标 IC（可选）
│   ├── Cushing_OK_WTI_Spot_Price_FOB.csv
│   ├── Europe_Brent_Spot_Price_FOB.csv
│   ├── DJIA_daily.csv
│   ├── Oil Regional Refining Margins.xlsx
│   └── ... 其他原始数据
├── 因子构建组/                       # 各因子的构建脚本与说明，与“相关性分析和去重”并列
│   ├── all_factors_summary_latest.csv
│   └── 价差、炼油景气度、消费动量、价格动量、价格波动/ 等子目录
└── 相关性分析和去重/                 # 本分析项目所在目录（见下）
```

### 2.2 「相关性分析和去重」目录结构

```
相关性分析和去重/
├── config.py                    # 配置文件：路径、阈值、图表选项
├── run_pipeline.py              # 主入口：依次执行 1→2→3
├── 1_correlation_analysis.py   # 步骤 1：相关矩阵、缺失/基本统计、每对 Pearson、图表
├── 2_factor_clustering_dedup.py # 步骤 2：高相关去重、聚类树状图
├── 3_factor_filter.py          # 步骤 3：质量过滤，产出最终保留/剔除列表
├── check_env.py                # 环境检查脚本
├── requirements.txt            # Python 依赖列表
├── README.md                   # 简要使用说明
├── 项目使用与结构说明.md        # 本文档
└── output/                     # 运行后生成的结果目录（见下）
```

### 2.3 输出目录（output/）结构及说明

运行 `run_pipeline.py` 后，所有结果在 **`相关性分析和去重/output/`** 下：

```
output/
├── filtered_factors.csv              # 【最终结果】保留的因子列表（供下游建模）
├── removed_factors.csv               # 【最终结果】被剔除的因子及原因
├── factor_correlation_matrix.csv    # 因子间 Pearson 相关矩阵（方阵）
├── factor_missing_stats.csv         # 各因子：有效数、缺失数、有效占比、缺失占比
├── factor_basic_stats.csv           # 各因子：均值、标准差、方差、最小值、最大值
├── factor_clusters.csv              # 去重步骤中每个因子的状态：kept / removed
├── high_corr_pairs.csv              # 高相关因子对及相关系数（|r|≥阈值）
├── factor_target_ic.csv             # 各因子与油价收益率的 Pearson（若提供油价）
├── missing_ratio_bar.png            # 缺失率条形图（旧位置，建议以 figures 为准）
└── figures/                         # 可视化与每对 Pearson 表
    ├── all_pairwise_pearson.csv     # 每两个因子的 Pearson 表（factor_a, factor_b, pearson_r）
    ├── correlation_heatmap.png      # 相关矩阵热力图
    ├── missing_ratio_bar.png        # 各因子缺失率条形图
    ├── top_pairs_pearson_bar.png    # 相关系数绝对值最大的前 N 对条形图
    ├── cluster_dendrogram.png       # 因子层次聚类树状图（1-|r|）
    └── pair_scatter/                # 高相关因子对散点图（每对一张）
        ├── scatter_01_xxx_vs_yyy.png
        └── ...
```

| 文件/文件夹 | 用途说明 |
|-------------|----------|
| **filtered_factors.csv** | 最终保留的因子名列表，对应主数据集列名，用于从 `ULTIMATE_OIL_PRICE_DATASET.csv` 中选取列做建模。 |
| **removed_factors.csv** | 被剔除的因子及 reason（去重剔除、有效占比低、方差为 0、目标 IC 过弱等），便于复核与调参。 |
| **factor_correlation_matrix.csv** | 任意两因子间的 Pearson 相关系数矩阵，供去重与人工查看。 |
| **factor_missing_stats.csv** | 去重时用于“保留有效观测多的因子”；质量过滤时用于有效占比阈值。 |
| **factor_basic_stats.csv** | 质量过滤时用于剔除方差为 0/NaN 的因子。 |
| **factor_clusters.csv** | 区分去重后保留（kept）与剔除（removed）的因子。 |
| **high_corr_pairs.csv** | 满足 |r|≥阈值的因子对及 r 值，对应去重时被拆开的对。 |
| **factor_target_ic.csv** | 若配置了油价则存在；用于步骤 3 中按 |IC| 过滤。 |
| **figures/all_pairwise_pearson.csv** | 每两个因子的 Pearson 相关系数一览表（上三角，无自身）。 |
| **figures/*.png、pair_scatter/** | 相关热力图、缺失率、Top 对条形图、聚类树、高相关对散点图，便于直观查看。 |

---

## 三、保留与删除因子的策略

本流程对因子的处理分为两步：**先按相关性去重，再按质量过滤**。只有通过两步的因子才会出现在 **filtered_factors.csv** 中；其余会出现在 **removed_factors.csv** 并带有原因。

### 3.1 第一步：高相关去重（保留/删除策略）

- **依据**：因子间 **Pearson 相关系数绝对值 |r|**；使用步骤 1 生成的 `factor_correlation_matrix.csv`。
- **阈值**：`config.CORR_DEDUP_THRESHOLD`，默认 **0.85**。
- **规则**：
  - 找出所有满足 **|r| ≥ 0.85** 的因子对（不含自身，每对只算一次）。
  - 按 **|r| 从高到低**依次处理每一对；对每一对中**只保留一个因子，剔除另一个**。
  - **保留谁**：保留**有效观测数（valid_count）更多**的那个因子；若相同则保留前者、剔除后者。
- **结果**：
  - **保留**：在所有高相关对里都被选中的因子 → 写入 `factor_clusters.csv` 的 `dedup_status = kept`。
  - **删除**：因与某因子高相关而被剔除的 → `dedup_status = removed`；具体哪些对见 `high_corr_pairs.csv`。

**总结**：高相关对中保留“数据更完整”的代表因子，其余删除，以减少冗余与多重共线性。

### 3.2 第二步：质量过滤（保留/删除策略）

- **对象**：仅对**去重后仍保留**的因子（即 `factor_clusters.csv` 中 `dedup_status = kept`）做过滤。
- **数据来源**：`factor_missing_stats.csv`、`factor_basic_stats.csv`，若有则用 `factor_target_ic.csv`。

**删除规则（满足任一条即删除）：**

| 规则 | 条件 | 说明 |
|------|------|------|
| 有效观测占比过低 | 有效观测数/总行数 < **MIN_VALID_RATIO**（默认 0.30） | 缺失过多，信息不可靠。 |
| 方差无效 | 方差为 **0 或 NaN** | 近似常数或无数值，无信息量。 |
| 与目标相关性过弱（可选） | 存在油价且 与油价收益率的 \|IC\| < **MIN_TARGET_IC_ABS**（默认 0.01） | 与预测目标几乎无线性关系；未提供油价则不执行。 |

**保留规则**：未触发上述任一删除条件的去重保留因子 → 写入 **filtered_factors.csv**；被删的写入 **removed_factors.csv**，并在 **reason** 列标明具体原因（如 `low_valid_ratio`、`zero_or_nan_variance`、`low_target_ic`）。

### 3.3 策略汇总表

| 阶段 | 保留 | 删除 |
|------|------|------|
| **去重（步骤 2）** | 在高相关对中，每对保留有效观测数多的因子；未被任何对剔除的因子全部保留。 | 与某因子 |r|≥0.85 且在该对中有效观测数更少（或与前者并列时被选为剔除方）的因子。 |
| **质量过滤（步骤 3）** | 去重保留因子中：有效占比≥30%、方差>0 且非 NaN、若启用目标则 \|IC\|≥0.01。 | 有效占比<30%，或方差为 0/NaN，或（若启用）\|IC\|<0.01。 |

**最终**：仅同时通过“去重保留”和“质量过滤保留”的因子会出现在 **filtered_factors.csv**；其余均在 **removed_factors.csv** 中并带 reason。

---

## 四、快速查阅

- **怎么跑**：见 **一、本项目使用方法**。
- **输入输出在哪、每个文件干什么**：见 **二、文件夹与文件结构说明**。
- **哪些因子被保留、哪些被删、依据是什么**：见 **三、保留与删除因子的策略**。
- **最终结果怎么用**：见 **最终结果说明.md**。
